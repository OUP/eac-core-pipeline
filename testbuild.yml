version: 0.2

phases:
  install:
    commands:
      - echo '#!/bin/bash' > /usr/local/bin/ok; echo 'if [[ "$CODEBUILD_BUILD_SUCCEEDING" == "0" ]]; then exit 1; else exit 0; fi' >> /usr/local/bin/ok; chmod +x /usr/local/bin/ok
  pre_build:
    commands:
      - export AMI_ID=$(cat eac-core/packer/ami_id.txt)
      - echo "${AMI_ID}"
      - echo "Installing Ansible ..."
      - apt install software-properties-common -y && add-apt-repository --yes --update ppa:ansible/ansible -y
      - apt install ansible -y
      - cd eac-core/
      - cd packer/
      - echo "Validating Packer template ..."
      - ./packer validate packer_test.json
  build:
    commands:
      - echo "Running build for packer ..."
      - ./packer build -color=false -parallel-builds=1 -timestamp-ui packer_test.json | tee amitest.log
  post_build:
    commands:
      - echo "Test completed on `date`"

artifacts:
  files:
    - './amitest.log'