version: 0.2

phases:
  pre_build:
    commands:
      - export AMI_ID=$(cat eac-core/packer/ami_id.txt)
      - echo "${AMI_ID}"
      - echo "Installing Ansible ..."
      - apt install software-properties-common -y && add-apt-repository --yes --update ppa:ansible/ansible -y
      - apt install ansible -y
      - cd eac-core/
      - cd packer/
      - echo "Validating Packer template ..."
      - ./packer validate packer_test.json
  build:
    on-failure: ABORT
    commands:
      - echo "Running build for packer ..."
      - ./packer build -color=false -parallel-builds=1 -timestamp-ui packer_test.json | tee amitest.log
      # The below if statement is needed to make CodeBuiuld fail if the Ansible tests do, as the Packer exit code is not enough to make CodeBuild unsuccessful.
      - if grep -q 'exit status 2' amitest.log; then exit 1; else echo "no exit status found, test successful!"; fi
  post_build:
    commands:
      - echo "Test completed on `date`"

artifacts:
  files:
    - './amitest.log'