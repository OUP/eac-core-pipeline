version: 0.2
phases:
  pre_build:
    commands:
      - echo "installing jq"
      - apt-get -y update
      - apt-get -y install jq
  build:
    commands:
      - AmiId=$(cat packer/${ENVIRONMENT}.json | jq -r '.Parameters.AmiId')
      - aws ssm put-parameter --type 'String' --name "/${PROJECT}-${BUILD_COMPONENT_NAME}/${ENVIRONMENT}/AMI-${BUILD_GIT_BRANCH}" --value $AmiId --overwrite
      - sed -i "s/<<AMI-ID>>/$AmiId/g" packer/release_event.json
      - sed -i "s/<<AMI-NAME>>/${PROJECT}-${BUILD_COMPONENT_NAME}-env-${ENVIRONMENT}-branch-${BUILD_GIT_BRANCH}-/g" packer/release_event.json
      - sed -i "s/<<Environment>>/${ENVIRONMENT}/g" packer/release_event.json
      - aws events put-events --entries file://packer/release_event.json