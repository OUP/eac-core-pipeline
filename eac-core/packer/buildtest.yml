version: 0.2
phases:
  pre_build:
    commands:
      - echo "installing chef components"
      - apt-get -y update
      - apt-get -y install build-essential ruby-dev git curl build-essential libxml2-dev libxslt-dev libssl-dev autoconf wget jq
      - wget --quiet https://packages.chef.io/files/stable/chefdk/3.1.0/ubuntu/14.04/chefdk_3.1.0-1_amd64.deb
      - dpkg -i chefdk_3.1.0-1_amd64.deb
  build:
    commands:
      - echo "stackname for AMI Testing is ${PROJECT}-${BUILD_COMPONENT_NAME}-AMITest-${ENVIRONMENT}"
      - OUTPUTS=$(aws cloudformation describe-stacks --stack-name ${PROJECT}-${BUILD_COMPONENT_NAME}-AMITest-${ENVIRONMENT} --output json --region eu-west-1 | jq 'reduce .Stacks[0].Outputs[] as $item ({}; . + {"\($item.OutputKey)":$item.OutputValue})')
      - TestInstanceId=$(echo $OUTPUTS | jq -r '.TestInstanceId')
      - TestInstanceDnsName=$(echo $OUTPUTS | jq -r '.TestInstanceDnsName')
      - AmiId=$(cat packer/${ENVIRONMENT}.json | jq -r '.Parameters.AmiId')
      - KeyName=$(cat packer/${ENVIRONMENT}.json | jq -r '.Parameters.KeyName')
      - echo "Connecting to EC2 instance ${TestInstanceDnsName} with SSH Key ${KeyName}"
      - echo "listing contents of packer directory"
      - ls packer
      - /opt/chefdk/bin/inspec exec test/inspec/test.rb -b ssh --host $TestInstanceDnsName --user ec2-user -i "packer/${KeyName}.pem" --sudo --reporter=junit:test/inspec.xml
  post_build:
    commands:
      - echo "one-time ssh key for debugging"
      - cat packer/${KeyName}.pem
      - echo "removing ssh key from AWS"
      - aws ec2 delete-key-pair --key-name $KeyName
artifacts:
  files:
     '**/*'
  reports:
    InspecReports:
      files:
        - 'test/inspec.xml'
      file-format: JunitXml
