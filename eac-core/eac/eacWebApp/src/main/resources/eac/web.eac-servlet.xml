<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	xmlns:p="http://www.springframework.org/schema/p"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:util="http://www.springframework.org/schema/util"
	xmlns:mvc="http://www.springframework.org/schema/mvc"		
	xmlns:ehcache="http://ehcache-spring-annotations.googlecode.com/svn/schema/ehcache-spring"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
			http://www.springframework.org/schema/beans/spring-beans-3.1.xsd			
			http://www.springframework.org/schema/context
			http://www.springframework.org/schema/context/spring-context-3.1.xsd
			http://www.springframework.org/schema/util
      		http://www.springframework.org/schema/util/spring-util-3.1.xsd
      		http://www.springframework.org/schema/mvc 
			http://www.springframework.org/schema/mvc/spring-mvc-3.1.xsd">

    <!-- Caching
    <ehcache:annotation-driven cache-manager="cacheManager" />
    
    <ehcache:config cache-manager="cacheManager">
        <ehcache:evict-expired-elements interval="60" />
    </ehcache:config>
 -->    
    <context:property-placeholder properties-ref="appConfig" system-properties-mode="OVERRIDE"/>  

	<context:component-scan base-package="com.oup.eac.web.controllers" >
	   	<context:include-filter expression="org.springframework.stereotype.Controller" type="annotation"/>    	
    </context:component-scan>
	
    <mvc:interceptors>

        <!-- INTERCEPTOR 1/12 -->
        <!--  Prevents EAC pages being cached in browsers -->
        <!-- see code for special IE only settings -->
        <bean class="com.oup.eac.web.interceptors.EacWebContentInterceptor">
            <property name="cacheSeconds" value="0"/>
            <property name="useExpiresHeader" value="true"/>
            <property name="useCacheControlHeader" value="true"/>
            <property name="useCacheControlNoStore" value="true"/>
        </bean>

        <!-- INTERCEPTOR 2/12 -->
        <!-- allows locale to be set via 'lang=' on requests to loginWidget.js -->
        <mvc:interceptor>
            <mvc:mapping path="/loginWidget.js*" />
            <bean class="com.oup.eac.web.interceptors.LocaleInterceptor" p:paramName="lang" />
        </mvc:interceptor>
        
        <!-- INTERCEPTOR 3/12 -->
        <!-- allows locale to be set via 'locale=' on any GET request -->
        <bean class="com.oup.eac.web.interceptors.LocaleInterceptor" p:paramName="locale" />

        <!-- INTERCEPTOR 4/12 -->
        <!-- allows locale to be set in the 'teachers club style' '?cc=jp&selLanguage=' on any GET request -->
        <bean class="com.oup.eac.web.interceptors.TeachersClubLocaleInterceptor"
            p:paramNameCountry="cc" p:paramNameLang="selLanguage">
            <property name="countryCodesToIgnore">
                <list>
                    <value>global</value>
                </list>
            </property>
        </bean>

        <!-- INTERCEPTOR 5/12 -->    
        <!--  Checks that you are logged in -->
        <mvc:interceptor>
            <mvc:mapping path="/productRegistration.htm*" />
            <mvc:mapping path="/profile.htm*" />
            <mvc:mapping path="/profileChangePassword.htm*" />
            
            <mvc:mapping path="/profileRedeemActivationCode.htm*" />
            <!-- <mvc:mapping path="/changePassword.htm*" />   -->          

            <mvc:mapping path="/internalActivationCode.htm*" />
            <mvc:mapping path="/reregister.htm*" />
            <mvc:mapping path="/modifyProductRegistration.htm*" />

            <bean class="com.oup.eac.web.interceptors.LoggedInCustomerInterceptor" >
                <constructor-arg index="0" ref="customerService" />
            </bean>
        </mvc:interceptor>
        
        <!-- INTERCEPTOR 6/12 -->
        <mvc:interceptor>

            <mvc:mapping path="/activationCode.htm*" />
            <mvc:mapping path="/internalActivationCode.htm*" />
            <mvc:mapping path="/reregister.htm*" />
            <mvc:mapping path="/productRegistration.htm*" />
            <bean class="com.oup.eac.web.interceptors.SharedUsersCannotAmendRegistrationsInterceptor" />
        </mvc:interceptor>
        
        
        <!-- INTERCEPTOR 7/12 -->
        <mvc:interceptor>
            <mvc:mapping path="/productRegistration.htm*" />
            <bean class="com.oup.eac.web.interceptors.ProductRegistrationDefinitionInterceptor"/>
        </mvc:interceptor>

        <!-- INTERCEPTOR 8/12 -->
        <mvc:interceptor>
            <mvc:mapping path="/modifyProductRegistration.htm*" />
            <bean class="com.oup.eac.web.interceptors.ProductRegistrationUpdateInterceptor" >
               <!--  <constructor-arg index="0" ref="registrationDefinitionService" /> -->
                <constructor-arg index="0" ref="registrationService" />
            </bean>
        </mvc:interceptor>

        <!-- INTERCEPTOR 9/12 -->
        <!-- prevent out of sequence form submissions -->
        <bean class="com.oup.eac.web.interceptors.EacInSyncInterceptor" p:enabled="${insync.check.enabled}" >
            <property name="ignoredPaths">
                <list>
                    <value>/login.htm</value>
                    <value>/basicLogin.htm</value>
                    <value>/cookieFromSession.htm</value>
                </list>
            </property>
            <!-- when Jboss can't find a resource such as a CSS file, it gets redirected to /404.htm - as an .htm file this gets picked up by Spring's DispatcherServlet so comes into here -->
            <property name="skipTokenRegenerationPaths">
                <list>
                    <value>/keepAlive.htm</value>
                    <value>/validatePassword.htm</value>
                    <value>/404.htm</value>
                    <value>/notFound.htm</value>
                </list>
            </property>
        </bean>

        <!-- INTERCEPTOR 10/12 -->
        <!--  Makes dateStyles available to all JSPs -->
        <bean id="dateFormatsInterceptor" class="com.oup.eac.web.interceptors.DateStylesInterceptor" >
            <constructor-arg name="dateTimeStyle" value="${formats.date.time.style}" /> 
            <constructor-arg name="dateStyle" value="${formats.date.style}" />
        </bean>

        <!-- INTERCEPTOR 11/12 -->    
        <!-- Makes available lanaguages selection available to all JSPs -->
        <bean id="availableLanguagesInterceptor"
            class="com.oup.eac.web.interceptors.AvailableLanguagesInterceptor">
            <constructor-arg ref="availableLanguages" />
        </bean>
        
        <!-- INTERCEPTOR 12/12 -->
        <mvc:interceptor>
            <mvc:mapping path="/productRegistration.htm*" />
            <mvc:mapping path="/accountRegistration.htm*" />
            <mvc:mapping path="/reregister.htm*" />
            <bean class="com.oup.eac.web.interceptors.RegistrationInterceptor" />
        </mvc:interceptor>
    </mvc:interceptors> 

	<bean class="org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping">
    	<property name="order" value="0" />
  	</bean>
  	
	<bean id="jacksonMessageConverter" class="org.springframework.http.converter.json.MappingJacksonHttpMessageConverter" />
	<bean class="org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter">
		<property name="messageConverters">
			<list>
				<ref bean="jacksonMessageConverter" />
			</list>
		</property>
	</bean>

    <bean id="localeResolver" class="org.springframework.web.servlet.i18n.SessionLocaleResolver" />
 
    <bean id="versionUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/version.htm">versionController</prop>
           </props>
       </property>
    </bean>
    
    <bean name="versionController" class="com.oup.eac.web.controllers.EACVersionController"/>
	
    <bean id="registrationAllowUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/registrationAllow.htm">registrationAllowController</prop>
           </props>
       </property>
    </bean> 
    
    <bean name="registrationAllowController" class="com.oup.eac.web.controllers.authentication.RegistrationAllowController">
        <constructor-arg ref="registrationService"/>
    </bean>	
    
    <bean id="validatorLicenceAllowedUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/validatorLicenceAllowed.htm">validatorRegistrationAllowController</prop>
           </props>
       </property>
    </bean> 
    
    <bean name="validatorRegistrationAllowController" class="com.oup.eac.web.controllers.authentication.ValidatorRegistrationAllowController">
        
    </bean>	
    
    <bean id="validatorLicenceDeniedUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/validatorLicenceDenied.htm">validatorRegistrationDenyController</prop>
           </props>
       </property>
    </bean> 
    
    <bean name="validatorRegistrationDenyController" class="com.oup.eac.web.controllers.authentication.ValidatorRegistrationDenyController">
    </bean>	
    
    <bean id="validateEmailUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/validateEmail.htm">validateEmailController</prop>
           </props>
       </property>
    </bean> 
    
    <bean name="validateEmailController" class="com.oup.eac.web.controllers.authentication.ValidateEmailController">
        <constructor-arg ref="customerService"/>
    </bean>
    
    <bean id="footerMappings" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/accessibility.htm">defaultContentController</prop>
              <prop key="/privacyAndLegal.htm">defaultContentController</prop>
           </props>
       </property>
    </bean>
    
    <bean name="defaultContentController" class="org.springframework.web.servlet.mvc.UrlFilenameViewController"/>
	
    <bean id="accessUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/access.htm">accessController</prop>
           </props>
       </property>
    </bean>	
	
	<bean name="accessController" class="com.oup.eac.web.controllers.authentication.AccessController">
		<constructor-arg index="0" ref="registrationDefinitionService" />
		<constructor-arg index="1" ref="domainSkinResolverService" />
		<constructor-arg index="2" ref="customerService" />
		<constructor-arg index="3" ref="registrationService" />
		<constructor-arg index="4" ref="productService" />
		<constructor-arg index="5" ref="licenceService" />
		<constructor-arg index="6" ref="registrationNotAllowedMessageCodeSource" />
		<constructor-arg index="7" ref="whiteListUrlService" />
	</bean>
    
    <bean id="loginUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/login.htm">loginController</prop>
           </props>
       </property>
    </bean>     
    
    <bean name="loginController" class="com.oup.eac.web.controllers.login.LoginFormController">
    	<constructor-arg ref="customerService"/>
    	<constructor-arg ref="domainSkinResolverService"/>
    	<constructor-arg ref="productService"/>
    	<constructor-arg ref="whiteListUrlService"/>
        <property name="sessionForm" value="false"/>
        <property name="commandName" value="loginFbo"/>
        <property name="commandClass" value="com.oup.eac.dto.LoginDto"/>
        <property name="validator">
            <bean class="com.oup.eac.web.validators.login.LoginFormValidator"/>
        </property>
        <property name="formView" value="loginForm"/>
    </bean>
    
    <bean id="logoutUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/logout.htm">logoutController</prop>
           </props>
       </property>
    </bean>     
    
    <bean name="logoutController" class="com.oup.eac.web.controllers.authentication.LogoutController">
        <constructor-arg ref="customerService"/>
        <constructor-arg ref="whiteListUrlService"/>
    </bean>
    
    <bean id="activationCodeUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/activationCode.htm">activationCodeController</prop>
           </props>
       </property>
    </bean>     
    
    <bean id="internalActivationCodeUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/internalActivationCode.htm">activationCodeController</prop>
           </props>
       </property>
    </bean>
    
    <bean name="activationCodeController" class="com.oup.eac.web.controllers.authentication.ActivationCodeFormController">
        <constructor-arg ref="registrationService"/>
		<constructor-arg ref="domainSkinResolverService"/>
		<constructor-arg ref="productService"/>
		<constructor-arg ref="customerService"/>
		<constructor-arg ref="activationCodeService"/>
		<constructor-arg ref="whiteListUrlService"/>
        <property name="sessionForm" value="false"/>
        <property name="commandName" value="activationCode"/>
        <property name="commandClass" value="com.oup.eac.domain.ActivationCode"/>
        <property name="formView" value="activationCodeForm"/>
        <property name="successView" value="login.htm"/>
        <property name="validator">
            <bean class="com.oup.eac.web.validators.login.ActivationCodeFormValidator">
                <constructor-arg ref="activationCodeService"/>
            </bean>
        </property>
    </bean>  
    
    <bean id="reregisterUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/reregister.htm">reregisterController</prop>
           </props>
       </property>
    </bean>     
    
    <bean name="reregisterController" class="com.oup.eac.web.controllers.authentication.ReregisterController"/>    
    
    <bean id="cookieErrorUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/cookieError.htm">cookieErrorController</prop>
           </props>
       </property>
    </bean>     
    
    <bean name="cookieErrorController" class="com.oup.eac.web.controllers.authentication.CookieErrorController"/>
    
    <bean id="crossSiteCookieMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/crossSiteCookie.htm">crossSiteCookieController</prop>
           </props>
       </property>
    </bean>     
    
    <bean name="crossSiteCookieController" class="com.oup.eac.web.controllers.authentication.CrossSiteCookieController">
        <property name="cacheSeconds" value="60" />    
        <property name="cookieName" value="ERIGHTS" />    
    </bean>
    

    <bean id="changePasswordMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/changePassword.htm">changePasswordController</prop>
           </props>
       </property>
    </bean>     
    
    <bean name="changePasswordController" class="com.oup.eac.web.controllers.authentication.ChangePasswordFormController">
        <constructor-arg ref="customerService"/>
        <constructor-arg ref="domainSkinResolverService"/>
        <property name="sessionForm" value="false"/>
        <property name="commandName" value="changePasswordDto"/>
        <property name="commandClass" value="com.oup.eac.dto.ChangePasswordDto"/>
        <property name="validator">
            <bean class="com.oup.eac.web.validators.login.ChangePasswordFormValidator"/>
        </property>
        <property name="formView" value="changePasswordForm"/>
        <property name="successView" value="login.htm"/>
    </bean>       
    
    <bean id="passwordResetUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/passwordReset.htm">passwordResetController</prop>
           </props>
       </property>
    </bean>     
    
    <bean name="passwordResetController" class="com.oup.eac.web.controllers.authentication.PasswordResetFormController">
    	<constructor-arg ref="customerService"/>
    	<constructor-arg ref="directRequestContextFactory"/>
        <property name="sessionForm" value="false"/>
        <property name="commandName" value="passwordResetFbo"/>
        <property name="commandClass" value="com.oup.eac.dto.PasswordResetDto"/>
        <property name="validator">
            <bean class="com.oup.eac.web.validators.login.PasswordResetFormValidator"/>
        </property>
        <property name="formView" value="passwordResetForm"/>
        <property name="successView" value="login.htm"/>
    </bean>   


	<bean id="accountRegistrationUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
	   <property name="mappings">
	       <props>
		      <prop key="/accountRegistration.htm">accountRegistrationController</prop>
	       </props>
	   </property>
	</bean>
	
    <bean name="accountRegistrationController" class="com.oup.eac.web.controllers.registration.AccountRegistrationFormController">
        <constructor-arg ref="registrationService"/>
        <constructor-arg ref="customerService"/>
        <constructor-arg ref="registrationDefinitionService"/>
        <constructor-arg ref="usernameValidator"/>
        <property name="sessionForm" value="false"/>
        <property name="commandName" value="accountRegistrationDto"/>
        <property name="commandClass" value="com.oup.eac.dto.AccountRegistrationDto"/>
        <!-- <property name="validator">
            <bean class="com.oup.eac.web.validators.registration.AccountRegistrationFormValidator">
            	<constructor-arg ref="customerService"/>
            	<constructor-arg ref="usernameValidator"/>
            </bean>
        </property> -->
        <property name="formView" value="accountRegistrationForm"/>
        <property name="successView" value="login.htm"/>
    </bean>
    
    <bean id="productRegistrationUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/productRegistration.htm">productRegistrationController</prop>
           </props>
       </property>
    </bean>
    
    <bean id="productRegistrationUpdateUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/modifyProductRegistration.htm">productRegistrationUpdateController</prop>
           </props>
       </property>
    </bean>

    <bean name="productRegistrationUpdateController" class="com.oup.eac.web.controllers.registration.ProductRegistrationUpdateController">
        <constructor-arg ref="registrationService"/>
        <property name="sessionForm" value="false"/>
        <property name="commandName" value="registrationDto"/>
        <property name="commandClass" value="com.oup.eac.dto.RegistrationDto"/>
        <!-- <property name="validator">
            <bean class="com.oup.eac.web.validators.registration.RegistrationFormValidator"/>
        </property> -->
        <property name="formView" value="productRegistrationForm"/>
        <property name="successView" value="login.htm"/>
    </bean>
    
    <bean name="productRegistrationController" class="com.oup.eac.web.controllers.registration.ProductRegistrationFormController">
        <constructor-arg ref="registrationService"/>
        <constructor-arg ref="customerService"/>
        <constructor-arg ref="erightsFacade"/>
        <property name="sessionForm" value="false"/>
        <property name="commandName" value="registrationDto"/>
        <property name="commandClass" value="com.oup.eac.dto.RegistrationDto"/>
        <!-- <property name="validator">
            <bean class="com.oup.eac.web.validators.registration.RegistrationFormValidator"/>
        </property> -->
        <property name="formView" value="productRegistrationForm"/>
        <property name="successView" value="login.htm"/>
    </bean>
    
    <mvc:view-controller path="/loggedOut.htm" view-name="loggedOut"/> 
    <!-- We map /404.htm to a redirect - which redirects back in to
    		/notFound.htm. This allows notFound.htm to be decorated
    		by sitemesh. Without the redirect, Spring would simply
    		forward - which wouldn't decorate the page in this context. -->
    <mvc:view-controller path="/404.htm" view-name="redirect:/notFound.htm"/> 
    <mvc:view-controller path="/notFound.htm" view-name="notFound"/> 
    <mvc:view-controller path="/keepAlive.htm" view-name="keepAlive"/> 
    <mvc:view-controller path="/activationError.htm" view-name="activationError"/>
    
    <bean id="exceptionResolver" class="com.oup.eac.web.exceptionresolver.EACExceptionResolver">
        <property name="defaultErrorView" value="error"/>
		<property name="exceptionMappings">
            <map>
                <entry key="NoSessionException" value="cookieError" />
            </map>
		</property>
    </bean>    
    
    <bean id="resourceLoader" class="org.springframework.core.io.FileSystemResourceLoader"/>
    
    <util:list id="availableLanguages" value-type="com.oup.eac.domain.EacLang">
		<bean class="com.oup.eac.domain.EacLang">
			<constructor-arg value="en"/>
			<constructor-arg value="label.english"/>
			<constructor-arg value="English"/>
		</bean>
	</util:list>

    <bean id="directRequestContextFactory" class="com.oup.eac.web.controllers.context.DirectRequestContextFactory">
        <constructor-arg ref="productService"/>
        <constructor-arg ref="domainSkinResolverService"/>
        <constructor-arg ref="registrationDefinitionService"/>
        <constructor-arg ref="erightsFacade"/>
        <constructor-arg ref="whiteListUrlService"/>
    </bean>
    
    <bean id="passwordResetFailureUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
       <property name="mappings">
           <props>
              <prop key="/passwordResetFailure.htm">passwordResetFailureController</prop>
           </props>
       </property>
    </bean>     
    
    <bean name="passwordResetFailureController" class="com.oup.eac.web.controllers.authentication.PasswordResetFailureController">
        
    </bean>
    
</beans>
