---
version: 0.2
phases:
  pre_build:
    commands:
      - echo "/${UPSTREAMSTACK}/${ENVIRONMENT}/${GOLDENAMIPIPELINE}"
      - export GOLDEN_AMI_ID=$(aws ssm get-parameters --name "/${UPSTREAMSTACK}/${ENVIRONMENT}/${GOLDENAMIPIPELINE}" --query "Parameters[0].Value" --output text)
      - echo "${GOLDEN_AMI_ID}"
      - cd eac-core/
      - cd packer/
      - echo "Installing Packer"
      - curl -o packer.zip https://releases.hashicorp.com/packer/1.5.1/packer_1.5.1_linux_amd64.zip && unzip packer.zip
      - cd ../../
      - cp -r build/ eac-core/packer/
      - cd eac-core/
      - cd packer/
      - echo "Validating Packer template"
      - ./packer validate packer.json
  build:
    commands:
      - echo "copy dependencies into place"
      - echo "running build for packer"
      - ./packer build -color=false -parallel=false -timestamp-ui packer.json | tee build.log
  post_build:
    commands:
      - egrep "${AWS_REGION}\:\sami\-" build.log | cut -d' ' -f2 > ami_id.txt
      - test -s ami_id.txt || exit 1
      - export AMI_ID=$(head -n 1 ami_id.txt)
      - echo "${AMI_ID}"
      - sed -ie "s@<<AMI-ID>>@${AMI_ID}@g" ${ENVIRONMENT}.json
      - sed -ie "s@<<VPC-ID>>@${BUILD_VPC_ID}@g" ${ENVIRONMENT}.json
      - sed -ie "s@<<SUBNET-ID>>@${BUILD_SUBNET_ID}@g" ${ENVIRONMENT}.json
      - sed -ie "s@<<AMI-PARAMETER>>@/${UPSTREAMSTACK}/${ENVIRONMENT}/Final-AMI@g" ${ENVIRONMENT}.json
      - cat ${ENVIRONMENT}.json
      - aws ssm put-parameter --type 'String' --name "/${UPSTREAMSTACK}/${ENVIRONMENT}/Final-AMI" --value $AMI_ID --overwrite
      - sed -ie "s@<<AMI-NAME>>@/${UPSTREAMSTACK}/${ENVIRONMENT}/Final-AMI@g" ami_builder_event.json
      - sed -i.bak "s/<<AMI-ID>>/$(cat ami_id.txt)/g" ami_builder_event.json
      - aws events put-events --entries file://ami_builder_event.json
      - cat ami_builder_event.json
      - echo "build completed on `date`"
      - ls -la
      - cd ..
      - ls -la
      - cd ..
      - ls -la
artifacts:
  files:
    - '/eac-core/test/**/*'
    - '/eac-core/packer/*'
    - '/cf-templates/*'
    - 'testbuild.yml'