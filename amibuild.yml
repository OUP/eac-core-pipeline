---
version: 0.2
phases:
  pre_build:
    commands:
      #- export BUILD_UPSTREAM_AMI=$(aws ssm get-parameters --name "/${UPSTREAMPROJECT}-common/${UPSTREAMPIPELINE}" --query "Parameters[0].Value" --output text)
      #- echo $(aws ssm get-parameters --name "/${UPSTREAMPROJECT}-common/${UPSTREAMPIPELINE}" --query "Parameters[0].Value" --output text)
      #- export DATE=$(date '+%s')
      #- export PACKER_LOG=1
      - cd eac-core/packer
      - echo "Installing Packer"
      - curl -o packer.zip https://releases.hashicorp.com/packer/1.5.1/packer_1.5.1_linux_amd64.zip && unzip packer.zip
      - echo "Validating Packer template"
      - ./packer validate packer.json
  build:
    commands:
      - echo "copy dependencies into place"
      - mkdir -p ../eacBuildsource/
      - cp -Rp ../build/target/* ../eacBuildsource/
      - echo "running build for packer"
      - ./packer build -color=false -parallel=false -timestamp-ui packer.json | tee build.log
  post_build:
    commands:
      #- aws ec2 create-key-pair --key-name ${PROJECT}-${ENVIRONMENT}-${PIPELINENAME}-${DATE}-key --query "KeyMaterial" --output text > ${PROJECT}-${ENVIRONMENT}-${PIPELINENAME}-${DATE}-key.pem
      - egrep "${AWS_REGION}\:\sami\-" build.log | cut -d' ' -f2 > ami_id.txt
      - test -s ami_id.txt || exit 1
      - export AMI_ID=$(head -n 1 ami_id.txt)
      - echo "${AMI_ID}"
      #- sed -ie "s@<<AMI-ID>>@${AMI_ID}@g" ${ENVIRONMENT}.json
      #- sed -ie "s@<<VPC-ID>>@${BUILD_VPC_ID}@g" ${ENVIRONMENT}.json
      #- sed -ie "s@<<SUBNET-ID>>@${TEST_SUBNET_ID}@g" ${ENVIRONMENT}.json
      #- sed -ie "s@<<KEYNAME>>@${PROJECT}-${ENVIRONMENT}-${PIPELINENAME}-${DATE}-key@g" ${ENVIRONMENT}.json
      #- cat ${ENVIRONMENT}.json
artifacts:
  files:
     - './packer/**/*'
     - './test/**/*'
     - './cf-templates/**/*'